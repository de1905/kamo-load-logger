{% extends "base.html" %}

{% block title %}Import History - KAMO Load Logger{% endblock %}

{% block extra_head %}
<style>
    .btn-delete {
        background: transparent;
        border: 1px solid #dc2626;
        color: #dc2626;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-delete:hover {
        background: #dc2626;
        color: white;
    }
    .btn-delete:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .status-toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        font-size: 0.875rem;
        z-index: 1000;
        display: none;
    }
    .status-toast.success {
        background: #d1fae5;
        color: #065f46;
        display: block;
    }
    .status-toast.error {
        background: #fee2e2;
        color: #991b1b;
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<h1>Import History</h1>

<div class="section">
    <div class="card">
        <div class="table-header">
            <span>Total: {{ "{:,}".format(total) }} imports</span>
            <span>Page {{ page }} of {{ total_pages }}</span>
        </div>

        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Started (CST)</th>
                    <th>Completed</th>
                    <th>Status</th>
                    <th>Load +/-</th>
                    <th>Subs +/-</th>
                    <th>Duration</th>
                    <th>Error</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for import in imports %}
                <tr class="{% if import.status == 'failed' %}row-error{% endif %}">
                    <td>{{ import.id }}</td>
                    <td>{{ import.started_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td>{% if import.completed_at %}{{ import.completed_at.strftime('%H:%M:%S') }}{% else %}-{% endif %}</td>
                    <td>
                        {% if import.status == 'success' %}
                        <span class="badge badge-success">Success</span>
                        {% elif import.status == 'failed' %}
                        <span class="badge badge-danger">Failed</span>
                        {% elif import.status == 'running' %}
                        <span class="badge badge-warning">Running</span>
                        {% else %}
                        <span class="badge badge-secondary">{{ import.status }}</span>
                        {% endif %}
                    </td>
                    <td>+{{ import.load_records_imported }} / -{{ import.load_records_skipped }}</td>
                    <td>+{{ import.substation_records_imported }} / -{{ import.substation_records_skipped }}</td>
                    <td>{% if import.duration_seconds %}{{ "%.2f"|format(import.duration_seconds) }}s{% else %}-{% endif %}</td>
                    <td class="error-cell" title="{{ import.error_message or '' }}">
                        {% if import.error_message %}
                        {{ import.error_message[:50] }}{% if import.error_message|length > 50 %}...{% endif %}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn-delete" onclick="deleteImport({{ import.id }}, this)" title="Delete this import">Delete</button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="9" class="text-center">No import history</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Pagination -->
        {% if total_pages > 1 %}
        <div class="pagination">
            {% if page > 1 %}
            <a href="/history?page={{ page - 1 }}" class="btn">&laquo; Previous</a>
            {% endif %}

            <span class="page-info">Page {{ page }} of {{ total_pages }}</span>

            {% if page < total_pages %}
            <a href="/history?page={{ page + 1 }}" class="btn">Next &raquo;</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<div class="status-toast" id="toast"></div>
{% endblock %}

{% block extra_scripts %}
<script>
    async function deleteImport(importId, btn) {
        if (!confirm(`Delete import #${importId}?`)) return;

        btn.disabled = true;
        btn.textContent = '...';

        try {
            const response = await fetch(`/api/imports/${importId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                // Remove the row from the table
                const row = btn.closest('tr');
                row.style.transition = 'opacity 0.3s';
                row.style.opacity = '0';
                setTimeout(() => row.remove(), 300);
                showToast('Import deleted', 'success');
            } else {
                const data = await response.json();
                showToast(data.detail || 'Failed to delete', 'error');
                btn.disabled = false;
                btn.textContent = 'Delete';
            }
        } catch (e) {
            console.error('Delete failed:', e);
            showToast('Failed to delete import', 'error');
            btn.disabled = false;
            btn.textContent = 'Delete';
        }
    }

    function showToast(message, type) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `status-toast ${type}`;
        setTimeout(() => {
            toast.className = 'status-toast';
        }, 3000);
    }
</script>
{% endblock %}
